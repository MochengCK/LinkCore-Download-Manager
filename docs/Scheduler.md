# 调度引擎配置教程 / Scheduler Configuration Guide

## 目录 / Table of Contents

- [简介](#简介)
- [功能说明](#功能说明)
- [配置步骤](#配置步骤)
- [参数详解](#参数详解)
- [使用建议](#使用建议)
- [常见问题](#常见问题)

---

## 简介

调度引擎是联芯下载管理器的一项高级功能，旨在自动优化下载任务的连接分配，提升整体下载效率。

### 解决的问题

1. **下载末期速度下降**：当下载任务接近完成时，部分连接已完成其分配的片段而闲置，导致整体下载速度明显下降
2. **长时间低速下载**：某些任务可能因服务器限制或网络问题而长时间处于低速状态

### 工作原理

调度引擎通过以下方式自动优化下载：

1. 实时监控每个任务的下载速度和进度
2. 检测速度异常下降或持续低速的任务
3. 通过智能重新分配连接来恢复下载速度
4. 整个过程静默执行，用户无需干预

---

## 功能说明

### 触发条件

调度引擎在以下情况下会自动触发重新调度：

**模式一：高进度 + 速度下降**
- 下载进度超过 90%
- 当前速度低于峰值速度的 30%
- 连续检测到 3 次低速

**模式二：持续低速**
- 峰值速度超过设定的最小阈值
- 当前速度低于峰值的指定百分比（默认 20%）
- 连续检测到 8 次低速

### 不会触发的情况

- 文件大小小于设定的最小值（默认 10MB）
- BT/磁力链接任务（有自己的片段分配机制）
- 已达到最大重分配次数限制
- 两次重分配间隔小于 15 秒

---

## 配置步骤

### 1. 打开设置

点击应用左下角的设置图标，进入「进阶设置」页面。

### 2. 找到调度引擎设置

向下滚动找到「调度引擎」设置卡片。

### 3. 启用调度引擎

勾选「启用调度引擎」选项。

### 4. 配置参数

根据您的需求调整以下参数：

- 低速触发阈值
- 最小峰值速度
- 最小文件大小
- 最大重分配次数

### 5. 保存配置

配置会自动保存，重启应用后仍然有效。

---

## 参数详解

### 启用调度引擎

| 项目 | 说明 |
|------|------|
| 默认值 | 不启用 |
| 建议 | 如果经常遇到下载末期速度下降，建议启用 |

### 低速触发阈值

| 项目 | 说明 |
|------|------|
| 范围 | 5% - 50% |
| 默认值 | 20% |
| 含义 | 当下载速度低于峰值速度的此百分比时，触发调度 |

**设置建议：**
- 网络稳定：可设置为 15%-20%
- 网络波动较大：建议设置为 25%-30%
- 设置过低可能导致频繁触发，设置过高可能无法及时响应

### 最小峰值速度

| 项目 | 说明 |
|------|------|
| 范围 | 1 - 9999 |
| 单位 | KB/s 或 MB/s |
| 默认值 | 100 KB/s |
| 含义 | 只有峰值速度超过此值的任务才会考虑低速触发 |

**设置建议：**
- 此参数用于过滤本身速度就很慢的任务
- 如果服务器限速 50KB/s，则无需对其进行重调度
- 一般设置为您期望的最低可接受速度

### 最小文件大小

| 项目 | 说明 |
|------|------|
| 范围 | 1 - 9999 |
| 单位 | MB 或 GB |
| 默认值 | 10 MB |
| 含义 | 小于此大小的文件不进行调度 |

**设置建议：**
- 小文件下载很快，无需调度
- 建议保持默认值 10MB
- 如果主要下载大文件，可适当提高

### 最大重分配次数

| 项目 | 说明 |
|------|------|
| 范围 | 1 - 20 |
| 默认值 | 5 |
| 含义 | 单个任务最多重新分配的次数 |

**设置建议：**
- 过多的重分配可能影响下载稳定性
- 一般 3-5 次足够
- 如果服务器支持断点续传，可适当提高

---

## 使用建议

### 推荐配置

#### 普通用户（默认配置）

```
启用调度引擎: ✓
低速触发阈值: 20%
最小峰值速度: 100 KB/s
最小文件大小: 10 MB
最大重分配次数: 5
```

#### 高速网络用户

```
启用调度引擎: ✓
低速触发阈值: 15%
最小峰值速度: 1 MB/s
最小文件大小: 50 MB
最大重分配次数: 3
```

#### 网络不稳定用户

```
启用调度引擎: ✓
低速触发阈值: 30%
最小峰值速度: 50 KB/s
最小文件大小: 10 MB
最大重分配次数: 8
```

---

## 常见问题

### Q: 调度引擎会影响正常下载吗？

**A:** 不会。调度引擎只在检测到速度明显下降时才会触发，正常下载不受影响。

### Q: 为什么我的任务没有触发调度？

**A:** 可能的原因：
1. 文件大小小于最小文件大小设置
2. 峰值速度未达到最小峰值速度设置
3. 已达到最大重分配次数
4. 任务是 BT/磁力链接类型

### Q: 调度后速度没有提升怎么办？

**A:** 这可能是服务器端的限制，调度引擎无法突破服务器的速度限制。您可以：
1. 尝试在不同时间段下载
2. 使用多个下载源
3. 检查网络连接

### Q: 配置保存后重启应用会丢失吗？

**A:** 不会。所有配置都会持久化保存，重启应用后保持不变。

### Q: 可以查看调度引擎的工作日志吗？

**A:** 调度引擎设计为静默工作，不会显示任何通知。您可以通过观察任务的速度变化来判断是否触发了调度。

---

## 技术说明

### 监控机制

- 采样频率：每秒采集一次速度数据
- 历史记录：保留最近 15 次速度采样
- 进度阈值：90%（高进度模式）

### 重分配机制

调度引擎通过以下步骤重新分配连接：

1. 暂停目标任务
2. 等待连接释放
3. 恢复任务下载
4. aria2 自动重新分配下载片段

### 保护机制

- 最小间隔：15 秒
- 最大次数限制：防止无限循环
- 任务类型过滤：排除 BT 任务

---

## 版本历史

| 版本 | 日期 | 更新内容 |
|------|------|----------|
| 1.0 | 2024-12 | 初始版本，支持基本调度功能 |

---

如有问题或建议，欢迎在 [GitHub Issues](https://github.com/hugetiny/LinkCore/issues) 中反馈。
